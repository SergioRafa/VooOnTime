<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight On Time - Dashboard IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        input#origem, input#destino { text-transform: uppercase; }
        .loading-text { color: var(--secondary); font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        /* Pequeno ajuste para destacar a rota no card principal */
        .info-rota { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; display: block; }
    </style>
</head>
<body>
    <main class="apresentacao">
        <section class="apresentacao__conteudo">
            <h1 class="apresentacao__conteudo__titulo">‚úàÔ∏è Flight <span class="titulo-destaque">On Time</span></h1>
            <p>Monitoramento Preditivo de Opera√ß√µes A√©reas</p>
            
            <form id="meuFormulario" class="pesquisar">
                <div class="field-container">
                    <label><i class="fas fa-plane-departure"></i> Origem</label>
                    <input type="text" id="origem" placeholder="Ex: GIG" maxlength="3" required>
                </div>
                <div class="field-container">
                    <label><i class="fas fa-plane-arrival"></i> Destino</label>
                    <input type="text" id="destino" placeholder="Ex: GRU" maxlength="3" required>
                </div>
                <div class="field-container">
                    <label><i class="fas fa-route"></i> Dist√¢ncia (Km)</label>
                    <input type="number" id="distanciaKm" placeholder="Ex: 500" required>
                </div>
                <div class="field-container">
                    <label><i class="fas fa-calendar-alt"></i> Data</label>
                    <input type="date" id="dataPartida" required>
                </div>
                <button type="button" class="btn-analisar" id="btnAnalisar" onclick="enviarDados(event)">
                    <i class="fas fa-microchip"></i> EXECUTAR AN√ÅLISE IA
                </button>
            </form>

            <div id="resultado" class="resultado-container" style="display:none;">
                <div id="mensagem-retorno"></div>
            </div>

            <div class="historico-container">
                <h3><i class="fas fa-history"></i> Hist√≥rico de Monitoramento</h3>
                <table class="historico-table">
                    <thead>
                        <tr>
                            <th>Voo</th>
                            <th>Clima</th>
                            <th>Vento</th>
                            <th>Risco</th>
                        </tr>
                    </thead>
                    <tbody id="corpo-historico">
                        </tbody>
                </table>
            </div>
        </section>

        <img class="apresentacao__imagem" src="https://images.unsplash.com/photo-1542296332-2e4473faf563?q=80&w=1000&auto=format&fit=crop" alt="Avi√£o decolando">
    </main>

    <script>
// Vari√°vel global para memorizar a √∫ltima busca
let ultimaBusca = { origem: "", destino: "", data: "" };

async function enviarDados(event) {
    if(event) event.preventDefault();
    
    const msg = document.getElementById('mensagem-retorno');
    const resDiv = document.getElementById('resultado');
    const btn = document.getElementById('btnAnalisar');

    // 1. Captura de valores
    const orig = document.getElementById('origem').value.toUpperCase().trim();
    const dest = document.getElementById('destino').value.toUpperCase().trim();
    const dist = document.getElementById('distanciaKm').value;
    const data = document.getElementById('dataPartida').value;

    if(!orig || !dest || !dist || !data) {
        alert("Por favor, preencha todos os campos.");
        return;
    }

    // 2. BLINDAGEM: Verifica se a busca √© id√™ntica √† √∫ltima realizada
    if (orig === ultimaBusca.origem && dest === ultimaBusca.destino && data === ultimaBusca.data) {
        msg.innerHTML = `<p style="color: #f1c40f;">‚ö†Ô∏è Voc√™ j√° analisou esta rota para esta data. Altere os campos para uma nova consulta.</p>`;
        return; // Interrompe a execu√ß√£o aqui
    }

    const dados = {
        companhia: "Latam",
        origem: orig,
        destino: dest,
        dataPartida: data + "T12:00:00", 
        distanciaKm: parseFloat(dist)
    };

    // UI: Iniciando consulta
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ANALISANDO...';
    resDiv.style.display = 'block';
    msg.innerHTML = '<p class="loading-text">üì° Consultando IA e Clima Real...</p>';

    try {
        const url = 'https://uncompulsive-shelly-nonclerically.ngrok-free.dev/api/previsao/predict';
        
        const response = await fetch(url, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true' 
            },
            body: JSON.stringify(dados)
        });

        if (!response.ok) throw new Error(`Erro: ${response.status}`);

        const res = await response.json();

        // 3. SE SUCESSO: Atualiza a "Mem√≥ria" da √∫ltima busca
        ultimaBusca = { origem: orig, destino: dest, data: data };

        const probValue = res.probabilidade !== undefined ? res.probabilidade : 0;
        const probPerc = Math.round(probValue * 100);
        const temp = res.temp_celsius !== undefined ? res.temp_celsius : "--";
        const vento = res.vento_kmh !== undefined ? res.vento_kmh : "--";

        let classeColor = probPerc > 50 ? 'resultado-perigo' : (probPerc > 25 ? 'resultado-alerta' : 'resultado-sucesso');
        resDiv.className = `resultado-container ${classeColor}`;
        
        msg.innerHTML = `
            <h2>Risco de Atraso: ${probPerc}%</h2>
            <p>üå°Ô∏è <strong>Temp:</strong> ${temp}¬∞C | üå¨Ô∏è <strong>Vento:</strong> ${vento} km/h</p>
            <span class="info-rota">${orig} ‚ûî ${dest}</span>
        `;

        adicionarAoHistorico(orig, dest, temp, vento, probPerc);

    } catch (e) {
        console.error("Erro na integra√ß√£o:", e);
        resDiv.className = 'resultado-container resultado-perigo';
        msg.innerHTML = `<p>‚ùå Erro de Conex√£o: O servidor est√° ativo?</p>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-microchip"></i> EXECUTAR NOVA AN√ÅLISE';
    }
}

function adicionarAoHistorico(orig, dest, temp, vento, prob) {
    const corpo = document.getElementById('corpo-historico');
    const novaLinha = corpo.insertRow(0);
    let classeBadge = prob > 50 ? 'badge-perigo' : (prob > 25 ? 'badge-alerta' : 'badge-sucesso');
    
    novaLinha.innerHTML = `
        <td><strong>${orig}</strong> ‚ûî <strong>${dest}</strong></td>
        <td>${temp}¬∞C</td>
        <td>${vento} km/h</td>
        <td><span class="badge ${classeBadge}">${prob}%</span></td>
    `;
    novaLinha.style.animation = "fadeInUp 0.5s ease-out forwards";
}
    </script>
</body>
</html>