<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight On Time - Dashboard IA</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <style>
        input#origem, input#destino { text-transform: uppercase; }
        .loading-text { color: var(--secondary); font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .info-rota { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; display: block; }
    </style>
</head>

<body>
<main class="apresentacao">
    <section class="apresentacao__conteudo">
        <h1 class="apresentacao__conteudo__titulo">
            ‚úàÔ∏è Flight <span class="titulo-destaque">On Time</span>
        </h1>
        <p>Monitoramento Preditivo de Opera√ß√µes A√©reas</p>

        <form class="pesquisar">
            <div class="field-container">
                <label><i class="fas fa-plane-departure"></i> Origem</label>
                <input type="text" id="origem" placeholder="Ex: GIG" maxlength="3" required>
            </div>

            <div class="field-container">
                <label><i class="fas fa-plane-arrival"></i> Destino</label>
                <input type="text" id="destino" placeholder="Ex: GRU" maxlength="3" required>
            </div>

            <div class="field-container">
                <label><i class="fas fa-route"></i> Dist√¢ncia (Km)</label>
                <input type="number" id="distanciaKm" placeholder="Ex: 500" required>
            </div>

            <div class="field-container">
                <label><i class="fas fa-calendar-alt"></i> Data</label>
                <input type="date" id="dataPartida" required>
            </div>

            <button type="button" class="btn-analisar" id="btnAnalisar" onclick="enviarDados(event)">
                <i class="fas fa-microchip"></i> EXECUTAR AN√ÅLISE IA
            </button>
        </form>

        <div id="resultado" class="resultado-container" style="display:none;">
            <div id="mensagem-retorno"></div>
        </div>

        <div class="historico-container">
            <h3><i class="fas fa-history"></i> Hist√≥rico de Monitoramento</h3>
            <table class="historico-table">
                <thead>
                    <tr>
                        <th>Voo</th>
                        <th>Clima</th>
                        <th>Vento</th>
                        <th>Risco</th>
                    </tr>
                </thead>
                <tbody id="corpo-historico"></tbody>
            </table>
        </div>
    </section>

    <img class="apresentacao__imagem"
         src="https://images.unsplash.com/photo-1542296332-2e4473faf563?q=80&w=1000&auto=format&fit=crop"
         alt="Avi√£o decolando">
</main>

<script>
let ultimaBusca = { origem: "", destino: "", data: "" };

async function enviarDados(event) {
    if(event) event.preventDefault();

    const msg = document.getElementById('mensagem-retorno');
    const resDiv = document.getElementById('resultado');
    const btn = document.getElementById('btnAnalisar');

    const orig = document.getElementById('origem').value.toUpperCase().trim();
    const dest = document.getElementById('destino').value.toUpperCase().trim();
    const dist = document.getElementById('distanciaKm').value;
    const dataInput = document.getElementById('dataPartida').value;

    if(!orig || !dest || !dist || !dataInput){
        alert("Preencha todos os campos.");
        return;
    }

    if(orig === ultimaBusca.origem && dest === ultimaBusca.destino && dataInput === ultimaBusca.data){
        msg.innerHTML = `<p style="color:#f1c40f;">‚ö†Ô∏è Esta rota j√° foi analisada para esta data.</p>`;
        return;
    }

    // Tratamento correto da data para pegar o dia da semana (0-6)
    const dataObj = new Date(dataInput + "T12:00:00"); // For√ßa meio-dia para evitar erro de fuso
    const diaSemanaNum = dataObj.getDay();

    
    const dados = {
        origem: orig,
        destino: dest,
        distanciaKm: parseFloat(dist),
        dataPartida: dataInput,
        // Campos extras que a IA precisa (o Java vai repassar pro Flask)
        umidadePerc: 0.0,
        horaPartida: 12.0,
        trafegoCritico: 0.0,
        tempCelsius: 22.3,
        ventoKmh: 6.6,
        diaSemana: diaSemanaNum
    };

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ANALISANDO...';
    resDiv.style.display = 'block';
    msg.innerHTML = '<p class="loading-text">üì° Consultando modelo de IA...</p>';

    try {
        const response = await fetch('https://uncompulsive-shelly-nonclerically.ngrok-free.dev/api/previsao/predict', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(dados)
        });

        if(!response.ok) {
            const erroTexto = await response.text();
            console.error("Erro do Servidor:", erroTexto);
            throw new Error("Erro no backend: " + response.status);
        }

        const res = await response.json();

        // O Java deve retornar um objeto que contenha a probabilidade
        const probabilidadeVal = res.probabilidade !== undefined ? res.probabilidade : res.resultado;

        if(probabilidadeVal === undefined){
            throw new Error("Resposta inv√°lida do modelo");
        }

        ultimaBusca = { origem: orig, destino: dest, data: dataInput };

        const probPerc = Math.round(probabilidadeVal * 100);
        const emoji = probPerc > 50 ? '‚ö†Ô∏è' : '‚úÖ';

        let classeColor = probPerc > 50 ? 'resultado-perigo' : probPerc > 25 ? 'resultado-alerta' : 'resultado-sucesso';
        resDiv.className = `resultado-container ${classeColor}`;

        msg.innerHTML = `
            <h2>${emoji} Risco de Atraso: ${probPerc}%</h2>
            <p>üå°Ô∏è ${res.tempCelsius || 22.3}¬∞C | üå¨Ô∏è ${res.ventoKmh || 6.6} km/h</p>
            <span class="info-rota">${orig} ‚ûî ${dest}</span>
        `;

        adicionarAoHistorico(orig, dest, (res.tempCelsius || 22.3), (res.ventoKmh || 6.6), probPerc);

    } catch (e) {
        console.error(e);
        resDiv.className = 'resultado-container resultado-perigo';
        msg.innerHTML = `<p>‚ùå Falha: ${e.message}</p>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-microchip"></i> EXECUTAR NOVA AN√ÅLISE';
    }
}

function adicionarAoHistorico(orig, dest, temp, vento, prob){
    const corpo = document.getElementById('corpo-historico');
    const row = corpo.insertRow(0);
    const badge = prob > 50 ? 'badge-perigo' : prob > 25 ? 'badge-alerta' : 'badge-sucesso';

    row.innerHTML = `
        <td><strong>${orig}</strong> ‚ûî <strong>${dest}</strong></td>
        <td>${temp}¬∞C</td>
        <td>${vento} km/h</td>
        <td><span class="badge ${badge}">${prob}%</span></td>
    `;
} 
</script>

</body>
</html>
